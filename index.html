<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #111827;
      color: white;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    .grid-container {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(2, 1fr);
    }
    @media (min-width: 1280px) {
      .grid-container { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 1024px) {
      .grid-container { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .grid-container { grid-template-columns: 1fr; }
    }
    .video-card {
      background: #1f2937;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .card-header {
      padding: .75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
      background: #0b1220;
    }
    .card-footer {
      padding: .5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: .5rem;
      border-top: 1px solid #334155;
      background: rgba(0,0,0,0.15);
    }
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #0b1220;
      border-bottom: 1px solid #334155;
    }
    .badge {
      font-size: .75rem;
      background: #0ea5e9;
      color: #0b1220;
      padding: .15rem .5rem;
      border-radius: 999px;
    }
    select, input[type="text"] {
      color: #0b1220;
    }
  </style>
  <script>
    (function() {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();
  </script>
</head>

<body>
  <!-- Barra superior -->
  <div class="toolbar">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Bras%C3%A3o_da_Pol%C3%ADcia_Militar_do_Estado_de_S%C3%A3o_Paulo.svg"
           alt="PMESP" class="h-8 w-auto">
      <div>
        <h1 class="text-xl font-semibold">Dashboard Programa de Policiamento com Drones</h1>
        <p class="text-sm opacity-70">Monitoramento em Tempo Real • Firebase RT</p>
      </div>
      <div class="ml-auto flex flex-wrap items-center gap-2">
        <label class="text-sm opacity-80">Modo:</label>
        <select id="modeSelect" class="rounded px-2 py-1 text-black">
          <option value="viewer">Visualizador</option>
          <option value="editor">Editor</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Editor -->
  <div id="editorPanel" class="max-w-7xl mx-auto px-4 py-4" hidden>
    <div class="bg-slate-800 rounded-xl p-4">
      <h2 class="text-lg font-semibold mb-3">Gerenciar Lives</h2>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="liveInput" type="text" class="rounded px-3 py-2 w-full" placeholder="Cole a URL do YouTube ou ID da live" />
        <input id="labelInput" type="text" class="rounded px-3 py-2 w-full md:w-64" placeholder="Rótulo (opcional), ex: Drone 01" />
        <button id="addBtn" class="bg-blue-600 hover:bg-blue-500 rounded px-3 py-2">Adicionar</button>
        <button id="clearBtn" class="bg-red-600 hover:bg-red-500 rounded px-3 py-2">Limpar tudo</button>
      </div>
    </div>
  </div>

  <!-- Grid -->
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div id="grid" class="grid-container"></div>
  </div>

  <script>
    const STORAGE_KEY = "droneLives";
    const DEFAULT_QUALITY = "tiny"; // 144p

    let players = {};
    let lives = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    let ytReady = false;

    function saveLives() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lives));
    }

    function extractVideoId(url) {
      if (!url) return null;
      try {
        if (/^[-_a-zA-Z0-9]{11}$/.test(url)) return url;
        const u = new URL(url);
        if (u.hostname.includes("youtube.com")) {
          if (u.pathname.startsWith("/live/")) return u.pathname.split("/live/")[1];
          if (u.pathname.startsWith("/watch")) return u.searchParams.get("v");
        }
        if (u.hostname === "youtu.be") return u.pathname.substring(1);
      } catch {
        return url;
      }
    }

    function render() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      lives.forEach((live, i) => {
        const vid = extractVideoId(live.id);
        const card = document.createElement("div");
        card.className = "video-card";

        const header = document.createElement("div");
        header.className = "card-header";
        header.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="font-semibold">${live.label || "Sem nome"}</span>
          </div>
          <button class="bg-red-600 hover:bg-red-500 rounded px-3 py-1 hidden" data-remove>Remover</button>
        `;
        card.appendChild(header);

        const playerDiv = document.createElement("div");
        const playerId = `player_${i}_${Date.now()}`;
        playerDiv.id = playerId;
        playerDiv.style.aspectRatio = "16/9";
        card.appendChild(playerDiv);

        // Seletor de qualidade
        const footer = document.createElement("div");
        footer.className = "card-footer";
        footer.innerHTML = `
          <label>Resolução:</label>
          <select class="rounded px-2 py-1 text-black">
            <option value="tiny">144p</option>
            <option value="small">240p</option>
            <option value="medium">360p</option>
            <option value="large">480p</option>
            <option value="hd720">720p</option>
            <option value="hd1080">1080p</option>
          </select>
        `;
        card.appendChild(footer);
        grid.appendChild(card);

        const select = footer.querySelector("select");
        select.value = live.quality || DEFAULT_QUALITY;

        select.addEventListener("change", () => {
          live.quality = select.value;
          saveLives();
          const p = players[playerId];
          if (p) applyQuality(p, select.value);
        });

        header.querySelector("[data-remove]").addEventListener("click", () => {
          lives.splice(i, 1);
          saveLives();
          render();
        });

        createPlayer(playerId, vid, live, select);
      });
    }

    function applyQuality(player, q) {
      if (!player) return;
      let tries = 0;
      const interval = setInterval(() => {
        try {
          player.setPlaybackQuality && player.setPlaybackQuality(q);
        } catch {}
        tries++;
        if (tries > 8) clearInterval(interval);
      }, 400);
    }

    function createPlayer(id, videoId, live, select) {
      if (!ytReady) {
        const interval = setInterval(() => {
          if (ytReady) {
            clearInterval(interval);
            createPlayer(id, videoId, live, select);
          }
        }, 200);
        return;
      }

      players[id] = new YT.Player(id, {
        videoId: videoId,
        playerVars: { autoplay: 1, mute: 1, playsinline: 1, controls: 0 },
        events: {
          onReady: (e) => {
            const q = live.quality || DEFAULT_QUALITY;
            applyQuality(e.target, q);
          },
          onStateChange: (e) => {
            if (e.data === YT.PlayerState.PLAYING) {
              const q = live.quality || DEFAULT_QUALITY;
              applyQuality(e.target, q);
            }
          },
        },
      });
    }

    window.onYouTubeIframeAPIReady = () => {
      ytReady = true;
      render();
    };

    document.getElementById("addBtn").onclick = () => {
      const input = document.getElementById("liveInput");
      const label = document.getElementById("labelInput");
      const vid = extractVideoId(input.value.trim());
      if (!vid) return alert("ID inválido.");
      lives.push({ id: vid, label: label.value.trim() || "", quality: DEFAULT_QUALITY });
      saveLives();
      input.value = "";
      label.value = "";
      render();
    };

    document.getElementById("clearBtn").onclick = () => {
      if (confirm("Limpar todas as lives?")) {
        lives = [];
        saveLives();
        render();
      }
    };

    document.getElementById("modeSelect").onchange = () => {
      const isEditor = document.getElementById("modeSelect").value === "editor";
      document.getElementById("editorPanel").hidden = !isEditor;
      document.querySelectorAll("[data-remove]").forEach((btn) => {
        btn.hidden = !isEditor;
      });
    };
  </script>
</body>
</html>
