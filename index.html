<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --card:#111827; }
    body { background:#111827; color:white; box-sizing:border-box; }
    .grid-container { display:grid; gap:1rem; grid-template-columns:repeat(2,1fr); }
    @media (min-width:1280px){ .grid-container{ grid-template-columns:repeat(3,1fr);} }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .grid-container{ grid-template-columns:1fr;} }
    .video-card{ background:#1f2937; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .card-header{ padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem; background:#0b1220; }
    .card-footer{ padding:.5rem 1rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; border-top:1px solid #334155 }
    .badge{ font-size:.75rem; background:#0ea5e9; color:#0b1220; padding:.15rem .5rem; border-radius:999px; }
    .btn{ background:#2563eb; padding:.5rem .75rem; border-radius:.5rem; }
    .btn:hover{ background:#1d4ed8; }
    .btn-danger{ background:#dc2626; }
    .btn-danger:hover{ background:#b91c1c; }
    .muted-icon{ font-size:.75rem; opacity:.8 }
    .hidden-when-viewer[hidden]{ display:none !important; }
    select, input[type="text"]{ color:#0b1220 }
    .toolbar{ position:sticky; top:0; z-index:40; background:#0b1220; border-bottom:1px solid #334155 }
  </style>
  <!-- YouTube IFrame API -->
  <script>
    // Carrega API de forma assíncrona
    (function(){
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();
  </script>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-semibold">Dashboard Programa de Policiamento com Drones</h1>
      <span class="badge">v9-rt-plus-viewcols+clear</span>
      <div class="ml-auto flex flex-wrap items-center gap-2">
        <!-- Toggle Editor/Visualizador -->
        <label class="text-sm opacity-80">Modo:</label>
        <select id="modeSelect" class="rounded px-2 py-1 text-black">
          <option value="viewer">Visualizador</option>
          <option value="editor">Editor</option>
        </select>

        <!-- Controle global de qualidade -->
        <label class="text-sm opacity-80">Qualidade padrão:</label>
        <select id="globalQuality" class="rounded px-2 py-1 text-black">
          <option value="tiny">144p</option>
          <option value="small">240p</option>
          <option value="medium">360p</option>
          <option value="large">480p</option>
          <option value="hd720">720p</option>
          <option value="hd1080">1080p</option>
          <option value="highres">Máx.</option>
        </select>
        <button id="applyAllBtn" class="btn">Aplicar a todas</button>
      </div>
    </div>
  </div>

  <!-- Editor -->
  <div id="editorPanel" class="max-w-7xl mx-auto px-4 py-4 hidden-when-viewer" hidden>
    <div class="bg-slate-800 rounded-xl p-4">
      <h2 class="text-lg font-semibold mb-3">Gerenciar Lives</h2>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="liveInput" type="text" class="rounded px-3 py-2 w-full" placeholder="Cole a URL do YouTube ou ID da live (ex: https://www.youtube.com/live/XXXX ou VIDEO_ID)" />
        <input id="labelInput" type="text" class="rounded px-3 py-2 w-full md:w-64" placeholder="Rótulo (opcional), ex: Drone 01" />
        <button id="addBtn" class="btn">Adicionar</button>
        <button id="clearBtn" class="btn btn-danger">Limpar tudo</button>
      </div>
      <p class="text-sm mt-2 opacity-80">As lives são salvas no seu navegador (localStorage). Você pode alternar para o modo Visualizador e tudo permanece igual.</p>
    </div>
  </div>

  <!-- Grid de vídeos -->
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div id="grid" class="grid-container"></div>
  </div>

  <script>
    // ---------- Armazenamento ----------
    const STORAGE_KEY = 'droneLivesV2';
    const QUALITY_KEY = 'defaultQualityV2'; // novo padrão
    const DEFAULT_QUALITY = 'tiny'; // 144p padrão

    // Migra se não existir
    if (!localStorage.getItem(QUALITY_KEY)) {
      localStorage.setItem(QUALITY_KEY, DEFAULT_QUALITY);
    }

    // ---------- Estado ----------
    let players = {}; // id -> YT.Player
    let lives = loadLives();
    let ytReady = false;

    function loadLives(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){ return JSON.parse(raw); }
      }catch(e){}
      return []; // começa vazio se não houver nada salvo
    }

    function saveLives(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lives));
    }

    function getDefaultQuality(){
      return localStorage.getItem(QUALITY_KEY) || DEFAULT_QUALITY;
    }

    function setDefaultQuality(q){
      localStorage.setItem(QUALITY_KEY, q);
    }

    // ---------- Util ----------
    function extractVideoId(input){
      if (!input) return null;
      // Aceita ID puro ou URLs /live/ /watch?v= /shorts/ etc.
      try{
        if (/^[-_a-zA-Z0-9]{11}$/.test(input)) return input; // id puro
        const u = new URL(input);
        if (u.hostname.includes('youtube.com')){
          if (u.pathname.startsWith('/live/')) return u.pathname.split('/live/')[1].split(/[?&]/)[0];
          if (u.pathname.startsWith('/watch')) return u.searchParams.get('v');
          if (u.pathname.startsWith('/shorts/')) return u.pathname.split('/shorts/')[1].split(/[?&]/)[0];
        }
        if (u.hostname === 'youtu.be'){
          return u.pathname.slice(1).split(/[?&]/)[0];
        }
      }catch(e){
        // não era URL, pode ser ID com tamanho diferente (algumas lives têm id longo)
        // fallback: retorna input cru e deixa o iframe tentar (alguns players aceitam IDs maiores)
        return input;
      }
      return null;
    }

    function humanQualityLabel(q){
      const map = {
        tiny: '144p',
        small: '240p',
        medium: '360p',
        large: '480p',
        hd720: '720p',
        hd1080: '1080p',
        highres: 'Máx.'
      };
      return map[q] || q;
    }

    // ---------- Render ----------
    function render(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      players = {};

      lives.forEach((live, idx) => {
        const vid = extractVideoId(live.id);
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.idx = idx;

        // header
        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="font-semibold">${live.label || 'Sem rótulo'}</span>
            <span class="muted-icon">(auto-mute)</span>
          </div>
          <div class="flex items-center gap-2 hidden-when-viewer" ${isEditor() ? '' : 'hidden'}>
            <button class="btn btn-danger" data-action="remove">Remover</button>
          </div>
        `;
        card.appendChild(header);

        // player box
        const playerBox = document.createElement('div');
        playerBox.style.position = 'relative';
        playerBox.style.aspectRatio = '16 / 9';
        const playerDivId = `player_${idx}_${Date.now()}`;
        playerBox.innerHTML = `<div id="${playerDivId}" style="width:100%; height:100%;"></div>`;
        card.appendChild(playerBox);

        // footer (resolução por live)
        const footer = document.createElement('div');
        footer.className = 'card-footer';

        const qualitySelect = document.createElement('select');
        qualitySelect.className = 'rounded px-2 py-1 text-black';
        ['tiny','small','medium','large','hd720','hd1080','highres'].forEach(q=>{
          const opt = document.createElement('option');
          opt.value = q;
          opt.textContent = humanQualityLabel(q);
          if ((live.quality || getDefaultQuality()) === q){ opt.selected = true; }
          qualitySelect.appendChild(opt);
        });
        qualitySelect.addEventListener('change', ()=>{
          live.quality = qualitySelect.value;
          saveLives();
          const p = players[playerDivId];
          if (p && p.setPlaybackQuality){
            p.setPlaybackQuality(live.quality);
          }
        });

        const lbl = document.createElement('span');
        lbl.className = 'text-sm opacity-80';
        lbl.textContent = 'Resolução desta live:';

        footer.appendChild(lbl);
        footer.appendChild(qualitySelect);
        card.appendChild(footer);

        // Eventos de header (remover)
        header.querySelectorAll('[data-action="remove"]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            lives.splice(idx,1);
            saveLives();
            render();
          });
        });

        grid.appendChild(card);

        // cria player quando API pronta
        createPlayerWhenReady(playerDivId, vid, live);
      });
    }

    function createPlayerWhenReady(divId, videoId, live){
      if (ytReady){
        makePlayer(divId, videoId, live);
      } else {
        const iv = setInterval(()=>{
          if (ytReady){
            clearInterval(iv);
            makePlayer(divId, videoId, live);
          }
        }, 150);
      }
    }

    function makePlayer(divId, videoId, live){
      try{
        const p = new YT.Player(divId, {
          videoId: videoId,
          playerVars: {
            autoplay: 1,
            mute: 1,
            playsinline: 1,
            controls: 0,
            rel: 0
          },
          events: {
            onReady: (e)=>{
              players[divId] = e.target;
              // Define qualidade padrão 144p (ou a salva por live)
              const q = live.quality || getDefaultQuality();
              safeSetQuality(e.target, q);
              // Play (autoplay depende do mute)
              try { e.target.playVideo(); } catch(_){}
            },
            onStateChange: (e)=>{
              // Quando começa a tocar, reforça qualidade (o YouTube às vezes muda sozinho)
              if (e.data === YT.PlayerState.PLAYING){
                const q = live.quality || getDefaultQuality();
                safeSetQuality(e.target, q);
              }
            }
          }
        });
      }catch(err){
        console.warn('Erro criando player', err);
      }
    }

    function safeSetQuality(player, q){
      try{
        // Em alguns navegadores, setPlaybackQuality pode ser "sugerido" e não garantido
        if (player && player.setPlaybackQuality){
          player.setPlaybackQuality(q);
        }
      }catch(_){}
    }

    // Chamado pela API do YouTube globalmente
    window.onYouTubeIframeAPIReady = function(){
      ytReady = true;
      render();
    };

    // ---------- Modo ----------
    function isEditor(){
      return (document.getElementById('modeSelect').value === 'editor');
    }

    function applyMode(){
      const panel = document.getElementById('editorPanel');
      const viewerHidden = !isEditor();
      panel.hidden = viewerHidden;
      // esconde botões de remover quando viewer
      document.querySelectorAll('.hidden-when-viewer').forEach(el=>{
        if (el.closest('#editorPanel')) return; // o painel inteiro já fica hidden
        if (viewerHidden) el.setAttribute('hidden','');
        else el.removeAttribute('hidden');
      });
    }

    // ---------- Controles Globais ----------
    document.getElementById('modeSelect').addEventListener('change', ()=>{
      applyMode();
    });

    // Inicializa modo a partir de query ?mode=viewer|editor (opcional)
    (function initModeFromQuery(){
      const qs = new URLSearchParams(location.search);
      const m = qs.get('mode');
      if (m === 'editor' || m === 'viewer'){
        document.getElementById('modeSelect').value = m;
      }
      applyMode();
    })();

    const globalQualitySelect = document.getElementById('globalQuality');
    globalQualitySelect.value = getDefaultQuality();

    globalQualitySelect.addEventListener('change', ()=>{
      setDefaultQuality(globalQualitySelect.value);
    });

    document.getElementById('applyAllBtn').addEventListener('click', ()=>{
      const q = globalQualitySelect.value;
      // Atualiza default e todas as lives visíveis
      setDefaultQuality(q);
      lives = lives.map(l => ({...l, quality: q}));
      saveLives();
      // Aplica nos players atuais
      Object.values(players).forEach(p=> safeSetQuality(p, q));
      // Atualiza selects individuais
      document.querySelectorAll('.card-footer select').forEach(sel=>{
        sel.value = q;
      });
    });

    // ---------- Editor: adicionar/limpar ----------
    document.getElementById('addBtn').addEventListener('click', ()=>{
      const input = document.getElementById('liveInput');
      const label = document.getElementById('labelInput');
      const vid = extractVideoId(input.value.trim());
      if (!vid){
        alert('Não consegui identificar o ID/URL do YouTube.');
        return;
      }
      lives.push({ id: vid, label: label.value.trim() || '', quality: getDefaultQuality() });
      saveLives();
      input.value = '';
      label.value = '';
      render();
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if (confirm('Tem certeza que deseja limpar todas as lives salvas?')){
        lives = [];
        saveLives();
        render();
      }
    });

    // ---------- “Failsafe” caso API do YT demore ----------
    setTimeout(()=>{ if (!ytReady) render(); }, 2000);
  </script>
</body>
</html>
