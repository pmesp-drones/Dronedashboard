<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>
  <!-- build: v14.1 - only live filter -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://i.ytimg.com">
  <link rel="preconnect" href="https://s.ytimg.com">

  <style>
    :root { --card:#111827; }
    * { box-sizing: border-box; }
    body { background:#111827; color:white; }
    .grid-container{ display:grid; gap:1rem; grid-template-columns:repeat(2,1fr);}
    @media(max-width:1024px){.grid-container{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid-container{grid-template-columns:1fr}}
    .video-card{background:#1f2937;border-radius:12px;overflow:hidden;border:1px solid #374151;}
    .video-box{aspect-ratio:16/9;position:relative;}
    .player-fill{position:absolute;inset:0;}
    .player-fill iframe{width:100%!important;height:100%!important;display:block;}
    .thumb{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .thumb img{width:100%;height:100%;object-fit:cover;filter:brightness(.8);}
    .badge-live{background:#dc2626;}
    .badge-ended{background:#4b5563;}
    .tile-btn{font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.15);border-radius:8px;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);}
    .tile-btn:hover{background:rgba(255,255,255,.08);}
    .offline-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;text-align:center;padding:1rem;background:linear-gradient(180deg,rgba(17,24,39,0.25),rgba(17,24,39,0.85));backdrop-filter:blur(2px);pointer-events:none;z-index:9;}
    .offline-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border:1px solid rgba(255,255,255,.25);border-radius:.5rem;font-size:.9rem;color:#e5e7eb;}
    .q-wrap{position:absolute;right:.5rem;bottom:.5rem;display:flex;align-items:center;gap:.4rem;z-index:20;}
    .q-btn{display:flex;align-items:center;gap:.35rem;font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.15);border-radius:8px;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);cursor:pointer;}
    .q-menu{position:absolute;right:0;bottom:2.2rem;background:#0b1220;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:.35rem;display:none;z-index:30;min-width:96px;}
  </style>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);
    const qsa=(s,e=document)=>Array.from(e.querySelectorAll(s));
    const AUTH_USER='OPERACAOCPM',AUTH_PASS='CAVPMDRONES',REMEMBER_MIN=240;
    function auth_ok_until(){const v=localStorage.getItem('auth_ok_until');return v?parseInt(v,10):0;}
    function set_auth_ok(){localStorage.setItem('auth_ok_until',String(Date.now()+REMEMBER_MIN*60*1000));}
    function doLogin(){const u=qs('#authUser')?.value?.trim()||'',p=qs('#authPass')?.value||'',err=qs('#authErr');
      if(u===AUTH_USER&&p===AUTH_PASS){set_auth_ok();qs('#authOverlay').style.display='none';return true;}
      err?.classList.remove('hidden');setTimeout(()=>err?.classList.add('hidden'),1500);return false;}

    /* ===== Firebase ===== */
    const FIREBASE={apiKey:"AIzaSyDadspZB30sQOgZr7PTcSbub1ZJB80Kui4",authDomain:"dashboarddronepmesp.firebaseapp.com",databaseURL:"https://dashboarddronepmesp-default-rtdb.firebaseio.com",projectId:"dashboarddronepmesp",storageBucket:"dashboarddronepmesp.firebasestorage.app",messagingSenderId:"769998411213",appId:"1:769998411213:web:f0ecce2126f0af9b4a2084"};
    const DB_PATH='dashboards/main';
    firebase.initializeApp(FIREBASE);
    const db=firebase.database(),dbRef=db.ref(DB_PATH);

    const params=new URLSearchParams(location.search);
    const MODE=(params.get('mode')||'edit').toLowerCase();
    const isView=MODE==='view';
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIDEO_IDS=[],LABELS=[],LOCS=[],MAIN_ID=null,YT_READY=false;
    const players={},activeGrid=new Set(),LRU=[];
    const DEFAULT_QUALITY='tiny',MAX_CONCURRENT_GRID=4;
    const Q_ORDER=['tiny','small','medium','large','hd720','hd1080','highres'];
    const Q_LABEL={tiny:'144p',small:'240p',medium:'360p',large:'480p',hd720:'720p',hd1080:'1080p',highres:'Máx.'};

    const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const idFromUrl=u=>{try{const url=new URL(u);return url.searchParams.get('v')||url.searchParams.get('list')||url.pathname.slice(1);}catch(_){return u;}};
    const isPlaylistId=id=>typeof id==='string'&&(id.startsWith('PL')||id.startsWith('UU'));
    const thumbUrl=id=>id?`https://i.ytimg.com/vi/${encodeURIComponent(id)}/hqdefault.jpg`:'https://i.ytimg.com/img/no_thumbnail.jpg';

    // === NEW: verificar se é live real ===
    async function isLiveBroadcast(videoId){
      try{
        const r=await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        const t=await r.json();
        return t?.liveBroadcastContent==="live";
      }catch{ return false; }
    }

    function setOfflineEl(id,flag){const el=document.getElementById(id);if(el)el.style.display=flag?'flex':'none';}

    /* ===== PLAYER CRIAÇÃO ===== */
    async function createGridPlayer(i,id,isPl){
      const mountId=`yt_${i}`,savedQ=localStorage.getItem('liveQ_'+id)||DEFAULT_QUALITY;
      // --- FILTRO: só se estiver realmente ao vivo ---
      const isLive=await isLiveBroadcast(id);
      if(!isLive){
        // Mostra thumbnail + selo "FINALIZADA"
        const card=qs(`#card_${i}`);
        if(card){
          const thumb=card.querySelector('[data-thumb]');
          if(thumb){thumb.classList.remove('hidden');}
          const badge=document.createElement('div');
          badge.className='absolute top-2 left-2 px-2 py-1 rounded text-[10px] badge-ended';
          badge.innerHTML='<span class="w-2 h-2 bg-white rounded-full"></span> FINALIZADA';
          card.querySelector('.video-box').appendChild(badge);
        }
        return;
      }
      // --- Se estiver live, cria normalmente ---
      players[i]=new YT.Player(mountId,{width:'100%',height:'100%',
        playerVars:{autoplay:1,mute:1,playsinline:1,controls:0,rel:0,modestbranding:1},
        events:{
          onReady:e=>{
            try{e.target.mute();e.target.playVideo();}catch(_){}
            setOfflineEl(`off_${i}`,false);
            activeGrid.add(i);
          },
          onStateChange:e=>{
            const on=(e.data===YT.PlayerState.PLAYING||e.data===YT.PlayerState.BUFFERING);
            setOfflineEl(`off_${i}`,!on);
          }
        }});
    }

    function destroyGridPlayer(i){const p=players[i];if(p?.destroy){try{p.destroy();}catch{}}players[i]=null;activeGrid.delete(i);}

    function renderMain(){
      const cont=qs('#mainContainer');cont.innerHTML='';
      if(!VIDEO_IDS.length){cont.classList.add('hidden');return;}
      cont.classList.remove('hidden');
      const id=MAIN_ID||VIDEO_IDS[0];const idx=VIDEO_IDS.indexOf(id);
      const label=LABELS[idx]||`Equipe ${idx+1}`;const loc=LOCS[idx]||'';
      const card=document.createElement('div');card.className='video-card';card.dataset.vid=id;card.dataset.idx='main';
      card.innerHTML=`
      <div class="video-box">
        <div id="yt_main" class="player-fill"></div>
        <div class="absolute top-2 left-24 px-2 py-1 rounded text-[10px] badge-live flex items-center gap-1">
          <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> AO VIVO (Principal)
        </div>
        <div class="offline-overlay" id="off_main"><div class="offline-badge"><span>OFFLINE • aguardando sinal</span></div></div>
      </div>
      <div class="px-3 pt-2 pb-3 bg-gray-800/70">
        <h3 class="font-semibold text-base">${esc(label)}</h3>
        <p class="text-gray-400 text-sm">${esc(loc)}</p>
      </div>`;
      cont.appendChild(card);
      if(YT_READY)new YT.Player('yt_main',{width:'100%',height:'100%',playerVars:{autoplay:1,mute:1,playsinline:1,controls:0}});
    }

    function renderGrid(){
      const grid=qs('#gridContainer');grid.innerHTML='';
      VIDEO_IDS.filter(id=>id!==MAIN_ID).forEach((id,i)=>{
        const idxOriginal=VIDEO_IDS.indexOf(id);
        const card=document.createElement('div');
        card.className='video-card';card.dataset.idx=String(i);card.dataset.vid=id;card.id=`card_${i}`;
        const tUrl=thumbUrl(id);
        card.innerHTML=`
        <div class="video-box">
          <div class="thumb" data-thumb><img src="${tUrl}" alt="thumb" loading="lazy"></div>
          <div id="yt_${i}" class="player-fill"></div>
          <div class="offline-overlay" id="off_${i}"><div class="offline-badge"><span>OFFLINE • aguardando sinal</span></div></div>
        </div>
        <div class="px-2 pt-1 pb-2 bg-gray-800/70">
          <h3 class="font-medium text-sm">${esc(LABELS[idxOriginal]||'Equipe '+(idxOriginal+1))}</h3>
          <p class="text-gray-400 text-[11px]">${esc(LOCS[idxOriginal]||'')}</p>
        </div>`;
        grid.appendChild(card);
        createGridPlayer(i,id,false);
      });
    }

    window.onYouTubeIframeAPIReady=function(){YT_READY=true;renderMain();renderGrid();};
    function subscribeRealtime(){dbRef.on('value',snap=>{const j=snap.val();if(!j)return;VIDEO_IDS=j.ids||[];LABELS=j.labels||[];LOCS=j.locs||[];MAIN_ID=j.main||VIDEO_IDS[0];renderMain();renderGrid();});}

    document.addEventListener('DOMContentLoaded',()=>{
      if(!isView&&auth_ok_until()<=Date.now()){qs('#authOverlay').style.display='flex';qs('#authForm')?.addEventListener('submit',e=>{e.preventDefault();doLogin();});}
      else{qs('#authOverlay').style.display='none';}
      subscribeRealtime();
    });
  })();
  </script>
</head>
<body class="min-h-screen">
  <!-- Overlay Login -->
  <div id="authOverlay" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/70">
    <div class="bg-gray-800 text-white w-full max-w-sm rounded-xl shadow-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Acesso restrito</h2>
      <form id="authForm" class="space-y-3">
        <div><label class="block text-sm mb-1">Usuário</label>
        <input id="authUser" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></div>
        <div><label class="block text-sm mb-1">Senha</label>
        <input id="authPass" type="password" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Entrar</button>
        <p id="authErr" class="text-red-400 text-sm hidden">Usuário ou senha incorretos.</p>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="p-4 bg-gray-900 border-b border-gray-700 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Logo_PMESP.png" class="w-10 h-10 bg-white/5 p-1 rounded">
        <div>
          <h1 class="text-lg font-bold">Dashboard Programa de Policiamento com Drones</h1>
          <p class="text-gray-400 text-xs">Versão 14.1 • Somente transmissões ao vivo</p>
        </div>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto p-4">
    <div id="mainContainer" class="video-card hidden"></div>
  </section>

  <main class="p-4 max-w-7xl mx-auto">
    <div id="gridContainer" class="grid-container"></div>
  </main>
</body>
</html>
