<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Programa de Policiamento com Drones</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --card:#111827; }
    body { background:#111827; color:white; box-sizing:border-box; }
    .grid-container { display:grid; gap:1rem; grid-template-columns:repeat(2,1fr); }
    @media (max-width:1024px){ .grid-container{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){  .grid-container{ grid-template-columns:1fr;} }
    .video-card{ background:#1f2937; border-radius:12px; overflow:hidden; border:1px solid #374151; }
    .video-box{ aspect-ratio:16/9; position:relative; }
    .player-fill{ position:absolute; inset:0; }
    .player-fill iframe{ width:100%!important; height:100%!important; display:block; border:0; }
    .tile-btn{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.15); border-radius:8px; }
    .tile-btn:hover{ background:rgba(255,255,255,.08); }
    .drag-over{ outline:2px dashed #60a5fa; outline-offset:-6px; }
    .hidden { display:none!important; }
  </style>

  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const qs=(s,e=document)=>e.querySelector(s);

    /* ========= Login simples (somente no modo editor) ========= */
    const AUTH_USER='OPERACAOCPM';
    const AUTH_PASS='CAVPMDRONES';
    const REMEMBER_MIN=240; // 4h

    const auth_ok_until = ()=> parseInt(localStorage.getItem('auth_ok_until')||'0',10);
    const set_auth_ok   = ()=> localStorage.setItem('auth_ok_until', String(Date.now()+REMEMBER_MIN*60*1000));
    function doLogin(){
      const u=qs('#authUser')?.value?.trim()||'', p=qs('#authPass')?.value||'', err=qs('#authErr');
      if(u===AUTH_USER && p===AUTH_PASS){ set_auth_ok(); qs('#authOverlay').style.display='none'; return true; }
      err?.classList.remove('hidden'); setTimeout(()=>err?.classList.add('hidden'),1500); return false;
    }

    /* ========= Firebase ========= */
    const FIREBASE = {
      apiKey: "AIzaSyDadspZB30sQOgZr7PTcSbub1ZJB80Kui4",
      authDomain: "dashboarddronepmesp.firebaseapp.com",
      databaseURL: "https://dashboarddronepmesp-default-rtdb.firebaseio.com",
      projectId: "dashboarddronepmesp",
      storageBucket: "dashboarddronepmesp.firebasestorage.app",
      messagingSenderId: "769998411213",
      appId: "1:769998411213:web:f0ecce2126f0af9b4a2084",
      measurementId: "G-4TVLS703CF"
    };
    const DB_PATH='dashboards/main';

    firebase.initializeApp(FIREBASE);
    const db=firebase.database();
    const dbRef=db.ref(DB_PATH);

    /* ========= Estado ========= */
    const params=new URLSearchParams(location.search);
    const MODE=(params.get('mode')||'edit').toLowerCase();
    const isView = MODE==='view';
    let COLS=parseInt(params.get('cols')||'2',10);
    let VIEW_COLS_OVERRIDE=null;

    let VIDEO_IDS=[], LABELS=[], LOCS=[];
    let YT_READY=false;
    const players = new Map(); // id -> YT.Player

    /* ========= Utils ========= */
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    // Extração ROBUSTA do ID (watch?v= | youtu.be | /live/ | /shorts/ | ID puro)
    function getYouTubeId(input){
      if(!input) return null;
      const raw = String(input).trim();
      if(/^[a-zA-Z0-9_-]{11}$/.test(raw)) return raw;
      try{
        const u = new URL(raw);
        if(u.hostname.includes('youtu.be')){
          const maybe=u.pathname.slice(1).split('/')[0];
          if(/^[a-zA-Z0-9_-]{11}$/.test(maybe)) return maybe;
        }
        const v = u.searchParams.get('v');
        if(v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;
        const m = u.pathname.match(/\/(live|shorts)\/([a-zA-Z0-9_-]{11})/);
        if(m) return m[2];
      }catch(_){}
      return null;
    }

    /* ========= Drag & Drop ========= */
    let dragSrcIndex=null;
    function attachDnD(cardEl, index){
      if(isView) return;
      cardEl.setAttribute('draggable','true');
      cardEl.addEventListener('dragstart', e=>{ dragSrcIndex=index; e.dataTransfer.effectAllowed='move'; cardEl.classList.add('opacity-80'); });
      cardEl.addEventListener('dragend',   ()=>{ cardEl.classList.remove('opacity-80'); document.querySelectorAll('.drag-over').forEach(x=>x.classList.remove('drag-over')); });
      cardEl.addEventListener('dragover',  e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; cardEl.classList.add('drag-over'); });
      cardEl.addEventListener('dragleave', ()=>{ cardEl.classList.remove('drag-over'); });
      cardEl.addEventListener('drop',      e=>{
        e.preventDefault();
        cardEl.classList.remove('drag-over');
        const targetIndex=parseInt(cardEl.dataset.idx,10);
        if(dragSrcIndex===null || dragSrcIndex===targetIndex) return;
        const move=(arr,from,to)=>{ const x=arr.splice(from,1)[0]; arr.splice(to,0,x); };
        move(VIDEO_IDS,dragSrcIndex,targetIndex);
        move(LABELS,   dragSrcIndex,targetIndex);
        move(LOCS,     dragSrcIndex,targetIndex);
        saveRealtime();
        renderGrid();
      });
    }

    /* ========= YouTube ========= */
    window.onYouTubeIframeAPIReady = function(){
      YT_READY=true;
      renderGrid();
    };

    function buildPlayer(i, id){
      // se já existir para este ID, destrói antes
      if(players.has(id)){
        try{ players.get(id).destroy(); }catch(_){}
        players.delete(id);
      }
      const p = new YT.Player(`yt_${i}`, {
        videoId: id,
        width: '100%', height: '100%',
        playerVars:{autoplay:1, mute:1, playsinline:1, controls:0, rel:0, modestbranding:1},
        events:{
          onReady: e => { try{ e.target.mute(); e.target.playVideo(); }catch(_){} },
          onStateChange: e => {
            const st = e.data;
            const card = document.getElementById(`card_${id}`);
            if (!card) return;
            const badge = card.querySelector('.live-badge');
            if (st === YT.PlayerState.PLAYING) {
              badge.textContent = 'AO VIVO';
              badge.classList.remove('bg-gray-500');
              badge.classList.add('bg-red-600');
            } else if (st === YT.PlayerState.UNSTARTED || st === YT.PlayerState.BUFFERING) {
              badge.textContent = 'AGUARDANDO SINAL';
              badge.classList.remove('bg-red-600');
              badge.classList.add('bg-gray-500');
            } else if (st === YT.PlayerState.ENDED || st === YT.PlayerState.PAUSED) {
              badge.textContent = 'OFFLINE';
              badge.classList.remove('bg-red-600');
              badge.classList.add('bg-gray-700');
            }
          }
        }
      });
      players.set(id, p);
    }

    function applyGridCols(){
      const cols = (isView && VIEW_COLS_OVERRIDE!=null) ? VIEW_COLS_OVERRIDE : COLS;
      const grid=qs('#gridContainer');
      if(grid) grid.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
      qs('#layout') && (qs('#layout').value=String(cols));
    }

    function renderGrid(){
      const grid=qs('#gridContainer');
      grid.innerHTML='';
      applyGridCols();

      if(LABELS.length<VIDEO_IDS.length){ for(let i=LABELS.length;i<VIDEO_IDS.length;i++) LABELS[i]=`Equipe ${String(i+1).padStart(2,'0')}`; }
      if(LOCS.length<VIDEO_IDS.length){   for(let i=LOCS.length;i<VIDEO_IDS.length;i++)   LOCS[i]=''; }

      if(!VIDEO_IDS.length){
        grid.innerHTML=isView
          ? '<div class="text-gray-400">Aguardando configuração do operador.</div>'
          : 'Clique em <b>Inserir Equipe</b> para começar.';
        return;
      }

      VIDEO_IDS.forEach((id,i)=>{
        const safeId = getYouTubeId(id) || id; // compatibilidade com dados antigos
        const card=document.createElement('div'); card.className='video-card'; card.dataset.idx=i; card.id=`card_${safeId}`;
        card.innerHTML=
        `<div class="video-box">
           <div id="yt_${i}" class="player-fill"></div>
           <div class="absolute top-2 left-2 px-2 py-1 rounded text-[10px] live-badge flex items-center gap-1 bg-gray-500">
             <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
             <span>AGUARDANDO SINAL</span>
           </div>
           <div class="absolute top-2 right-2 flex gap-2">
             <button class="tile-btn" onclick="window.open('https://www.youtube.com/watch?v=${encodeURIComponent(safeId)}','_blank')">Tela cheia</button>
             ${isView ? '' : `<button class="tile-btn" onclick="(function(){
               if(!confirm('Remover esta equipe?')) return;
               const idx=${i};
               VIDEO_IDS.splice(idx,1);
               LABELS.splice(idx,1);
               LOCS.splice(idx,1);
               saveRealtime();
               renderGrid();
             })()">Remover</button>`}
           </div>
         </div>
         <div class="px-2 pt-1 pb-0 bg-gray-800/70">
           <h3 class="font-medium text-sm">${esc(LABELS[i]||'Equipe '+(i+1))}</h3>
           <p class="text-gray-400 text-[11px]">${esc(LOCS[i]||'')}</p>
         </div>`;
        grid.appendChild(card);
        attachDnD(card,i);

        if(YT_READY){
          buildPlayer(i, safeId);
        }
      });
    }

    /* ========= Realtime ========= */
    function saveRealtime(){
      dbRef.set({ ids:VIDEO_IDS, labels:LABELS, locs:LOCS, cols:COLS, ts:Date.now() });
    }
    function subscribeRealtime(){
      dbRef.on('value', snap=>{
        const j=snap.val(); if(!j) return;
        const newIds=(j.ids||[]).map(getYouTubeId).filter(Boolean);
        const newLabels=j.labels||[];
        const newLocs=j.locs||[];
        COLS = parseInt(j.cols||COLS||2,10);

        const sameSet = newIds.length===VIDEO_IDS.length &&
                        [...newIds].sort().join(',') === [...VIDEO_IDS].sort().join(',');

        if(sameSet && YT_READY){
          // Reordena DOM sem recriar players
          const grid=qs('#gridContainer');
          newIds.forEach(id=>{
            const el=document.getElementById(`card_${id}`);
            if(el) grid.appendChild(el);
          });
          VIDEO_IDS=newIds.slice(); LABELS=newLabels.slice(); LOCS=newLocs.slice();

          // Atualiza textos
          newIds.forEach((id,idx)=>{
            const card=document.getElementById(`card_${id}`);
            if(card){
              const title=card.querySelector('h3'); const loc=card.querySelector('p.text-gray-400');
              if(title) title.textContent=newLabels[idx]||`Equipe ${idx+1}`;
              if(loc)   loc.textContent=newLocs[idx]||'';
            }
          });

          applyGridCols();
        } else {
          VIDEO_IDS=newIds.slice(); LABELS=newLabels.slice(); LOCS=newLocs.slice();
          renderGrid();
        }
      });
    }

    /* ========= UI ========= */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Mostrar/ocultar botões conforme modo
      qs('#btnShare')?.classList.toggle('hidden', isView);
      qs('#btnConfig')?.classList.toggle('hidden', isView);
      qs('#btnClearAll')?.classList.toggle('hidden', isView);

      // Login somente no editor
      if(!isView){
        if(auth_ok_until()<=Date.now()){
          qs('#authOverlay').style.display='flex';
          qs('#authForm')?.addEventListener('submit', e=>{ e.preventDefault(); doLogin(); });
        }
      } else {
        qs('#authOverlay').style.display='none';
      }

      // Cabeçalho
      qs('#btnFullscreen')?.addEventListener('click',()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); });

      // Layout select
      qs('#layout')?.addEventListener('change', ()=>{
        const val = parseInt(qs('#layout').value,10)||2;
        if(isView){
          VIEW_COLS_OVERRIDE = val;
          applyGridCols();
        } else {
          COLS = val;
          saveRealtime();
          applyGridCols();
        }
      });

      // Inserir equipe (editor)
      qs('#btnAddTeam')?.addEventListener('click', e=>{
        e.preventDefault();
        const name=qs('#teamName').value.trim();
        const loc=qs('#teamLocation').value.trim();
        const url=qs('#youtubeUrl').value.trim();
        if(!name||!url){ alert('Preencha Nome e URL'); return; }
        const id=getYouTubeId(url);
        if(!id){ alert('URL/ID do YouTube inválido.'); return; }
        VIDEO_IDS.push(id); LABELS.push(name); LOCS.push(loc);
        saveRealtime();
        renderGrid();
        qs('#configModal').classList.add('hidden'); qs('#teamForm').reset();
      });

      // Link do visualizador
      qs('#btnShare')?.addEventListener('click', ()=>{
        const base=location.origin+location.pathname;
        const url=new URL(base);
        url.searchParams.set('mode','view');
        url.searchParams.set('cols', String(COLS));
        url.searchParams.set('sync','rt');
        navigator.clipboard.writeText(url.toString()).then(()=>alert('Link do VISUALIZADOR copiado:\n\n'+url.toString()));
      });

      // Limpar tudo
      qs('#btnClearAll')?.addEventListener('click', ()=>{
        if(!confirm('Apagar TODAS as equipes do dashboard?')) return;
        // Destrói players atuais
        players.forEach(p=>{ try{p.destroy();}catch(_){}}); players.clear();
        VIDEO_IDS=[]; LABELS=[]; LOCS=[];
        saveRealtime();
        renderGrid();
      });

      subscribeRealtime();
    });
  })();
  </script>
</head>
<body class="min-h-screen">

  <!-- Overlay de Login (somente editor) -->
  <div id="authOverlay" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-black/70">
    <div class="bg-gray-800 text-white w-full max-w-sm rounded-xl shadow-xl p-6">
      <h2 class="text-lg font-semibold mb-4">Acesso restrito</h2>
      <form id="authForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Usuário</label>
          <input id="authUser" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="usuário">
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="authPass" type="password" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2" placeholder="senha">
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded">Entrar</button>
        <p id="authErr" class="text-red-400 text-sm hidden">Usuário ou senha incorretos.</p>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="p-4 bg-gray-900 border-b border-gray-700 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Logo_PMESP.png" alt="PMESP" class="w-10 h-10 object-contain rounded bg-white/5 p-1">
        <div>
          <h1 class="text-lg font-bold">Dashboard Programa de Policiamento com Drones</h1>
          <p class="text-gray-400 text-xs">Monitoramento em Tempo Real • Firebase RT</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-xs text-gray-400">Layout</label>
        <select id="layout" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
          <option value="2">2 colunas</option>
          <option value="3">3 colunas</option>
          <option value="4">4 colunas</option>
        </select>
        <button id="btnFullscreen" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">Tela Cheia</button>
        <button id="btnShare" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm">Gerar Link</button>
        <button id="btnConfig" class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-sm"
                onclick="document.getElementById('configModal').classList.remove('hidden')">
          Inserir Equipe
        </button>
        <button id="btnClearAll" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded text-sm">
          Limpar
        </button>
      </div>
    </div>
  </header>

  <!-- Grid -->
  <main class="p-4 max-w-7xl mx-auto">
    <div id="gridContainer" class="grid-container"></div>
  </main>

  <!-- Modal Inserir Equipe -->
  <div id="configModal" class="fixed inset-0 bg-black/60 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4 text-center">Inserir Equipe</h3>
        <form id="teamForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Nome da Equipe</label>
            <input id="teamName" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Ex.: Equipe Alfa">
          </div>
          <div>
            <label class="block text-sm mb-1">Endereço da Operação</label>
            <input id="teamLocation" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="Rua / Bairro / Ponto de referência">
          </div>
          <div>
            <label class="block text-sm mb-1">URL do YouTube (ou ID)</label>
            <input id="youtubeUrl" type="text" required class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="https://youtube.com/live/XXXXXXXXXXX ou ID de 11 caracteres">
          </div>
          <div class="flex gap-3 pt-2">
            <button id="btnAddTeam" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded">Adicionar</button>
            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded"
              onclick="document.getElementById('configModal').classList.add('hidden'); document.getElementById('teamForm').reset();">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>
</html>
