<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Lives dos Drones (YouTube)</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Painel responsivo com várias lives do YouTube e seletor de resolução por vídeo. Padrão 144p." />
  <style>
    /* ======= DESIGN - TEMA ======= */
    :root{
      --bg:#0b1220;
      --card:#111827;
      --muted:#9ca3af;
      --ring:rgba(96,165,250,.35);
      --gear-bottom-offset: 4px; /* <<< ajuste fino da posição vertical do ícone */
      --gear-right-offset: 10px; /* ajuste fino horizontal do ícone */
      --radius:12px;
    }

    /* ======= RESET SUAVE ======= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:#fff;
      font:500 15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{max-width:100%;display:block}
    button,select{font:inherit;color:inherit}

    /* ======= LAYOUT ======= */
    .wrap{max-width:1400px;margin:auto;padding:16px}
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px
    }
    .title{font-size:18px;font-weight:700;letter-spacing:.2px}
    .badge{
      font-size:12px;border:1px solid rgba(255,255,255,.18);
      border-radius:999px;padding:6px 10px;color:#d1d5db
    }

    .grid{
      display:grid;gap:14px;
      grid-template-columns:repeat(2,1fr);
    }
    @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:680px){ .grid{grid-template-columns:1fr} }

    /* ======= CARD DO VÍDEO ======= */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;position:relative;
    }
    .video-wrap{
      position:relative;aspect-ratio:16/9;background:#0a0a0a;overflow:hidden
    }
    .player-slot, .player-slot iframe{width:100%;height:100%}

    /* Overlays do player (ícones, toasts, etc) */
    .overlay{position:absolute;inset:0;pointer-events:none}

    /* ======= ÍCONE/SELETOR DE QUALIDADE ======= */
    .gear{
      position:absolute;right:var(--gear-right-offset);bottom:var(--gear-bottom-offset);
      pointer-events:auto;
      background:rgba(17,24,39,.9);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:8px;
      display:flex;align-items:center;gap:8px;
      backdrop-filter: blur(4px);
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      transition:transform .15s ease,opacity .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .gear:focus-within,.gear:hover{
      transform:translateY(1px);
      border-color:var(--ring);
      box-shadow:0 0 0 6px var(--ring);
    }
    .gear svg{width:18px;height:18px;opacity:.9;flex:0 0 auto}
    .gear select{
      appearance:none;background:transparent;color:#fff;border:none;
      font:600 13px/1 system-ui; padding-right:2px; cursor:pointer; outline:none;
    }
    .gear option{color:#000}

    /* ======= RODAPÉ DO CARD ======= */
    .meta{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;color:var(--muted);font-size:13px;
      border-top:1px solid rgba(255,255,255,.06)
    }

    /* ======= TOAST CURTO ======= */
    .toast{
      position:absolute;left:12px;bottom:12px;
      background:rgba(0,0,0,.7);padding:6px 10px;border-radius:8px;
      border:1px solid rgba(255,255,255,.12);font-size:12px;opacity:0;
      transform:translateY(6px);transition:opacity .18s ease,transform .18s ease
    }
    .toast.show{opacity:1;transform:translateY(0)}

    /* ======= ESTADO DE ERRO / OFF ======= */
    .error-banner{
      position:absolute;inset:auto 12px 12px 12px;
      background:rgba(185,28,28,.9);
      color:#fff;font-size:12px;padding:8px 10px;border-radius:8px;
      border:1px solid rgba(0,0,0,.2);display:none;pointer-events:auto
    }

    /* ======= SKELETON CARREGANDO ======= */
    .skeleton{
      position:absolute;inset:0;background:
        linear-gradient(90deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.12) 50%, rgba(255,255,255,.06) 100%);
      background-size:200% 100%;animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Dashboard – Lives dos Drones</div>
      <div class="badge">Qualidade padrão: 144p</div>
    </div>

    <!--
      COMO USAR:
      1) Substitua os IDs abaixo em WINDOW.VIDEOS (apenas o ID do YouTube, não a URL completa).
      2) Cada item é { id: "VIDEO_ID", title: "Rótulo do Card" }.
      3) A página monta os cards automaticamente e aplica 144p como padrão.
    -->
    <script>
      window.VIDEOS = [
        { id: "dQw4w9WgXcQ", title: "Drone 01 – Setor A" },
        { id: "5NV6Rdv1a3I", title: "Drone 02 – Setor B" },
        /* Adicione mais objetos aqui: { id:"<ID>", title:"Drone XX – Setor Y" } */
      ];
    </script>

    <div class="grid" id="videosGrid"></div>
  </div>

  <!-- ========= LÓGICA ========= -->
  <script>
    // Mapa de rótulos -> valores aceitos pela IFrame API
    const QUALITY_MAP = {
      '144p': 'tiny',
      '240p': 'small',
      '360p': 'medium',
      '480p': 'large',
      '720p': 'hd720',
      '1080p': 'hd1080'
    };
    const QUALITY_LIST = ['144p','240p','360p','480p','720p','1080p'];

    // Guardamos player e estado por card
    const stateByEl = new WeakMap(); // { player, desiredQ, isLiveGuess }

    // Cria o HTML de um card e instancia o player quando a API estiver pronta
    function createCard({id, title}){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.videoId = id;

      card.innerHTML = `
        <div class="video-wrap">
          <div class="player-slot" aria-label="${escapeHtml(title||'Transmissão')}">
            <div class="skeleton"></div>
          </div>

          <div class="overlay">
            <div class="gear" role="group" aria-label="Qualidade do vídeo">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 8.5a3.5 3.5 0 1 0 .001 6.999A3.5 3.5 0 0 0 12 8.5Zm9.94 3.06-1.74-.29a8.06 8.06 0 0 0-.63-1.52l1.07-1.4a.75.75 0 0 0-.1-1.01l-1.5-1.5a.75.75 0 0 0-1.01-.1l-1.4 1.07c-.49-.22-1-.43-1.52-.63l-.29-1.74A.75.75 0 0 0 13.5 2h-3a.75.75 0 0 0-.74.63l-.29 1.74c-.52.2-1.03.41-1.52.63L6.56 3.93a.75.75 0 0 0-1.01.1l-1.5 1.5a.75.75 0 0 0-.1 1.01l1.07 1.4c-.22.49-.43 1-.63 1.52l-1.74.29A.75.75 0 0 0 2 10.5v3c0 .37.27.68.63.74l1.74.29c.2.52.41 1.03.63 1.52l-1.07 1.4a.75.75 0 0 0 .1 1.01l1.5 1.5c.27.27.7.29 1.01.1l1.4-1.07c.49.22 1 .43 1.52.63l.29 1.74c.06.36.37.63.74.63h3c.37 0 .68-.27.74-.63l.29-1.74c.52-.2 1.03-.41 1.52-.63l1.4 1.07c.31.19.74.17 1.01-.1l1.5-1.5c.27-.27.29-.7.1-1.01l-1.07-1.4c.22-.49.43-1 .63-1.52l1.74-.29c.36-.06.63-.37.63-.74v-3a.75.75 0 0 0-.63-.74ZM12 17a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/>
              </svg>
              <select class="quality" aria-label="Selecionar qualidade">
                ${QUALITY_LIST.map(q => `<option value="${q}" ${q==='144p'?'selected':''}>${q}</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="toast" aria-live="polite"></div>
          <div class="error-banner">Falha ao carregar o vídeo. Verifique se a live está pública e habilitada para incorporação.</div>
        </div>

        <div class="meta">
          <div>${escapeHtml(title || 'Transmissão')}</div>
          <div class="badge">YouTube</div>
        </div>
      `;

      // Assim que a API estiver pronta, cria o player
      ensureYTReady().then(()=>{
        const slot = card.querySelector('.player-slot');
        const skeleton = slot.querySelector('.skeleton');
        const toast = card.querySelector('.toast');
        const errorBanner = card.querySelector('.error-banner');

        const player = new YT.Player(slot, {
          width:'100%', height:'100%',
          videoId: id,
          playerVars:{
            autoplay:1, mute:1, playsinline:1, rel:0, modestbranding:1,
            // dica inicial:
            vq:'tiny',
            // controls:1 // (padrão) – deixe 1 se quiser os controles do YT
          },
          events:{
            onReady:(e)=>{
              skeleton?.remove();
              // Forçar 144p no start
              safeSetQuality(e.target, 'tiny');
              // Guardar estado
              stateByEl.set(card, { player:e.target, desiredQ:'tiny', isLiveGuess:false });
              // Tentar inferir live (heurística)
              try{
                const dur = e.target.getDuration?.();
                stateByEl.get(card).isLiveGuess = (dur === 0 || !isFinite(dur));
              }catch{}
            },
            onStateChange:(e)=>{
              const st = stateByEl.get(card);
              if(!st) return;
              // Reaplicar qualidade quando começa a tocar / bufferiza
              if(e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.BUFFERING){
                safeSetQuality(e.target, st.desiredQ || 'tiny');
              }
            },
            onError:(e)=>{
              errorBanner.style.display = 'block';
              console.warn('YouTube Player error', e?.data, 'para vídeo', id);
            }
          }
        });

        // Handler do seletor de qualidade
        const select = card.querySelector('.quality');
        select.addEventListener('change', ()=>{
          const label = select.value;                // "360p", etc.
          const q = QUALITY_MAP[label] || 'tiny';    // "medium", etc.

          // guardar "desejada" para reaplicar em state changes
          const st = stateByEl.get(card) || {};
          st.desiredQ = q;
          stateByEl.set(card, { ...st, player });

          try{
            // Se não for live, preservar tempo
            const isLive = (player.getDuration?.() === 0);
            const t = isLive ? 0 : (player.getCurrentTime?.() || 0);

            // Recarrega com sugestão de qualidade (método mais eficaz)
            player.loadVideoById({ videoId:id, startSeconds:t, suggestedQuality:q });

            // Reforço extra:
            setTimeout(()=> safeSetQuality(player, q), 500);
            setTimeout(()=> safeSetQuality(player, q), 1500);

            // feedback visual
            showToast(toast, `Qualidade: ${label}`);
          }catch(err){
            console.warn('Falha ao trocar qualidade:', err);
            showToast(toast, 'Não foi possível trocar a qualidade');
          }
        });
      });

      return card;
    }

    function safeSetQuality(player, q){
      try{ player.setPlaybackQuality?.(q); }catch{}
    }

    function showToast(el, msg){
      if(!el) return;
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 1100);
    }

    // Escapar textos para segurança
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => (
        { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m]
      ));
    }

    // Garante a IFrame API carregada
    let ytReadyPromise;
    function ensureYTReady(){
      if (ytReadyPromise) return ytReadyPromise;
      ytReadyPromise = new Promise((resolve)=>{
        if (window.YT && window.YT.Player) return resolve();
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
      return ytReadyPromise;
    }

    // Monta a grade com base em window.VIDEOS
    (function init(){
      const grid = document.getElementById('videosGrid');
      if(!Array.isArray(window.VIDEOS) || window.VIDEOS.length === 0){
        // fallback simples
        window.VIDEOS = [{ id:'dQw4w9WgXcQ', title:'Exemplo – Substitua pelos seus IDs' }];
      }
      for(const item of window.VIDEOS){
        grid.appendChild(createCard(item));
      }
    })();
  </script>

  <!-- ACESSIBILIDADE SEM JS -->
  <noscript>
    <div style="max-width:700px;margin:20px auto;padding:12px;border-radius:10px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.1);">
      É necessário habilitar JavaScript para carregar os players do YouTube.
    </div>
  </noscript>
</body>
</html>
